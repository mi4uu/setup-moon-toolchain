name: 'Setup proto and moon toolchains bunifid'
author: 'Michal Lipinski'
description: 'Installs proto and moon globally when required, and caches the toolchain.'
inputs:
  auto-install:
    default: 'false'
    description: 'Auto-install tools on setup.'
  cache:
    description: 'Toggle caching of the toolchain directory.'
    default: 'true'
    required: false
  cache-base:
    description:
      'Base branch/ref to save a warmup cache on. Other branches/refs will restore from this base.'
  moon-version:
    default: ''
    description: 'Version of moon to install.'
    required: false
  proto-version:
    default: ''
    description: 'Version of proto to install.'
    required: false
  workspace-root:
    default: ''
    description: 'Path to the moon workspace root (if in a sub-directory).'
    required: false
outputs:
  cache-key:
    description: 'The cache key used for the toolchain folder (~/.proto).'
    value: ${{ steps.dist-index.outputs.cache-key }}
  cache-hit:
    description: 'A boolean to indicate an exact match was found for the cache key.'
    value: ${{ steps.dist-index.outputs.cache-hit }}
runs:
  using: 'composite'
  steps:
    - uses: actions/cache@v4
      id: cache
      with:
        path: |
          ~/.proto
        key: ${{ runner.os }}-proto
    - name: Install proto and moon
      if: steps.cache.outputs.cache-hit != 'true'
      run: |
            curl -fsSL https://moonrepo.dev/install/proto.sh | bash -s -- --yes
            pwd
            ls -la
            export PATH=$PATH:~/.proto/bin/
            proto plugin add moon "https://raw.githubusercontent.com/moonrepo/moon/master/proto-plugin.toml" --to global
            proto install moon
            proto install bun
      shell: bash
    - name: "run ci"
      id: dist-index
      run: |
        bun run --bun ./dist/index.js
        bun run --bun ./dist/post.js
      env:
        INPUT_CACHE: ${{ inputs.cache }}
        INPUT_CACHE-BASE: ${{ inputs.cache-base }}
        INPUT_MOON-VERSION: ${{ inputs.moon-version }}
        INPUT_PROTO-VERSION: ${{ inputs.proto-version }}
        INPUT_WORKSPACE-ROOT: ${{ inputs.workspace-root }}
      shell: bash



branding:
  icon: 'battery-charging'
  color: 'purple'
